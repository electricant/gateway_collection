<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Pielluzza IoT Dashboard</title>
  <!-- dygraphs library http://dygraphs.com/download.html -->
  <script src="//cdnjs.cloudflare.com/ajax/libs/dygraph/2.1.0/dygraph.min.js">
  </script>
  <link rel="stylesheet"
	href="//cdnjs.cloudflare.com/ajax/libs/dygraph/2.1.0/dygraph.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/mvp.css">
  <!-- <link href="css/style.css" rel="stylesheet" type="text/css"> -->
</head>
<body>
	<header>
		<h1 style="font-size:1.75em">Pielluzza IoT Dashboard</h1>
		<img src="https://wttr.in/Trieste_1q.png" alt="Weather in Trieste" 
			width="750">
	</header>
	
	<main>
		<section>
			<header>
				<h2 id="hStanza" style="font-size:1.25em;">
					cece-stanza:</h2>
				<p><a href="/data/cece-stanza.csv">
					get complete raw data as CSV</a></p>
			</header>
			<div id="graphdiv1"
				style="width:100%; height:200px; max-width:500px"></div>
		</section>
	
		<section>
			<header>
				<h2 id="hFuori" style="font-size:1.25em;">
					cece-fuori:</h2>
				<p><a href="/data/cece-fuori.csv">
					get complete raw data as CSV</a></p>
			</header>
			<div id="graphdiv2"
			     style="width:100%; height:200px; max-width:500px"></div>
		</section>
	</main>

	<script type="text/javascript">
		placeDygraph("graphdiv1", "cgi/get_last_week.pl?cece-stanza");
		placeDygraph("graphdiv2", "cgi/get_last_week.pl?cece-fuori");

		// Read latest temperature measurements and place them in the page
	    	fetch("/cgi/get_latest_meas.pl?cece-stanza+cece-fuori")
			.then(res => res.json())
			.then((o) => {
				console.log('cece-stanza', o['cece-stanza']);
				console.log('cece-fuori', o['cece-fuori']);

				var hStanza = document.getElementById("hStanza");
				displayLatestMeas(hStanza, o['cece-stanza'].temp,
							o['cece-stanza'].rhum);

				var hFuori = document.getElementById("hFuori");
				displayLatestMeas(hFuori, o['cece-fuori'].temp, 
							o['cece-fuori'].rhum);
			}).catch(err => { throw err });
		
		function zeropad(x) {
			return (x < 10) ? '0' + x : x;
		}

		function placeDygraph(where, data_url) {
			new Dygraph(document.getElementById(where), data_url,
			{
				series : { 
					"Temperature" : {
						axis : "y1",
						color : "red"
					},
					"Humidity" : {
						axis : "y2",
						color : "blue",
						fillGraph: true
					}
				},
				axes: { x: {
                  		axisLabelFormatter: function(d, gran, opts) {
						date = new Date(d * 1000);
						console.log(date);
                      			return date.getDate() + "-" 
							+ (1 + date.getMonth())
							+ " " + date.getHours() 
							+ ":" + zeropad(date.getMinutes());
                  		}
				}},
				ylabel : 'Temperature',
				y2label : 'Humidity',
				showRangeSelector: true,
				drawGapEdgePoints: true,
				rollPeriod: 2
			});
		}

		function round(number, decimals) {
			return Number(Math.round(number + "e" + decimals) + 
						"e-" + decimals)
		}

		function displayLatestMeas(element, temperature, humidity)
		{
			temperature = round(temperature, 1);
			humidity = round(humidity, 1);
			// https://stackoverflow.com/questions/26653729/insert-no-break-space-by-element-innertext
			element.textContent += " (T:\u00a0" + temperature +
						     "Â°,\u00a0H:\u00a0"+ humidity+ "%)";
		}
	</script>
</body>
</html>
